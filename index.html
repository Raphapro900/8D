<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Audio 8D + Reverb + Vista 3D</title>
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; text-align:center; }
    .dropzone { border:2px dashed #555; padding:20px; margin:20px; }
    .controls { margin:10px; }
    .stage { border:1px solid #555; height:300px; margin:20px; position:relative; }
    .dot { width:14px; height:14px; border-radius:50%; background:#7c5cff;
           position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
    #threeContainer { position:fixed; inset:0; background:#000; display:none; }
    #close3D { position:absolute; top:10px; right:10px; background:#c00; color:#fff;
               border:none; padding:8px 12px; cursor:pointer; font-size:16px; }
    canvas { display:block; }
  </style>
</head>
<body>
  <h1>Reproductor con efecto 8D</h1>

  <!-- Importar audio -->
  <div class="dropzone" id="dropzone">
    <p>Arrastra un archivo de audio aqu√≠ o selecci√≥nalo:</p>
    <input type="file" id="fileInput" accept="audio/*">
    <div class="controls">
      <button id="playBtn" disabled>‚ñ∂Ô∏è Play</button>
      <button id="pauseBtn" disabled>‚è∏Ô∏è Pause</button>
      <label><input type="checkbox" id="reverbToggle"> Reverb</label>
      <button id="open3D">üëÅÔ∏è Vista 3D</button>
    </div>
    <p id="fileName">Ning√∫n archivo cargado</p>
  </div>

  <!-- √Årea para mover el mouse -->
  <div class="stage" id="stage">
    <div class="dot" id="dot"></div>
  </div>

  <!-- Contenedor 3D -->
  <div id="threeContainer">
    <button id="close3D">X</button>
    <div id="threeScene"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
let audioCtx, sourceNode, gainNode, panner, convolver, dryGain, wetGain;
let currentBuffer=null;

// --- Audio ---
function ensureAudioGraph(){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if(!gainNode){ gainNode=audioCtx.createGain(); gainNode.connect(audioCtx.destination); }
  if(!panner){
    panner=audioCtx.createPanner();
    panner.panningModel='HRTF';
    panner.connect(gainNode);
  }
}
async function loadFile(file){
  ensureAudioGraph();
  const buf=await file.arrayBuffer();
  currentBuffer=await audioCtx.decodeAudioData(buf);
  document.getElementById("fileName").textContent=file.name;
  playBtn.disabled=false; pauseBtn.disabled=false;
}
function startPlayback(){
  if(!currentBuffer) return;
  stopPlayback();
  sourceNode=audioCtx.createBufferSource();
  sourceNode.buffer=currentBuffer;
  sourceNode.loop=true;
  sourceNode.connect(panner);
  sourceNode.start(); audioCtx.resume();
}
function stopPlayback(){ if(sourceNode){ sourceNode.stop(); sourceNode.disconnect(); sourceNode=null; } }

function setPanner(nx,ny){
  const cx=(nx-0.5)*2, cy=(ny-0.5)*2;
  const r=3;
  const x=cx*r, z=-cy*r, y=cy*r;
  const t=audioCtx?.currentTime||0;
  panner.positionX.linearRampToValueAtTime(x,t+0.02);
  panner.positionY.linearRampToValueAtTime(y,t+0.02);
  panner.positionZ.linearRampToValueAtTime(z,t+0.02);
  const rect=stage.getBoundingClientRect();
  dot.style.left=`${nx*rect.width}px`; dot.style.top=`${ny*rect.height}px`;
  update3D(x,y,z);
}

// --- Reverb ---
function createImpulse(duration=2,decay=2){
  const rate=audioCtx.sampleRate;
  const len=rate*duration;
  const impulse=audioCtx.createBuffer(2,len,rate);
  for(let ch=0;ch<2;ch++){
    const chan=impulse.getChannelData(ch);
    for(let i=0;i<len;i++){ chan[i]=(Math.random()*2-1)*Math.pow(1-i/len,decay); }
  }
  return impulse;
}
function ensureReverb(){
  if(!convolver){
    convolver=audioCtx.createConvolver();
    convolver.buffer=createImpulse();
    dryGain=audioCtx.createGain(); wetGain=audioCtx.createGain();
    dryGain.gain.value=1; wetGain.gain.value=0;
    panner.connect(dryGain); panner.connect(convolver);
    convolver.connect(wetGain);
    dryGain.connect(gainNode); wetGain.connect(gainNode);
  }
}
document.getElementById("reverbToggle").addEventListener("change",e=>{
  ensureReverb();
  wetGain.gain.value=e.target.checked?0.5:0.0;
});

// --- Eventos ---
const dropzone=document.getElementById("dropzone");
dropzone.addEventListener("drop",e=>{e.preventDefault(); loadFile(e.dataTransfer.files[0]);});
dropzone.addEventListener("dragover",e=>e.preventDefault());
fileInput.addEventListener("change",e=>loadFile(e.target.files[0]));
playBtn.addEventListener("click",startPlayback);
pauseBtn.addEventListener("click",stopPlayback);
stage.addEventListener("mousemove",e=>{
  const rect=stage.getBoundingClientRect();
  setPanner((e.clientX-rect.left)/rect.width,(e.clientY-rect.top)/rect.height);
});

// --- Vista 3D ---
let scene, camera, renderer, sourceMesh, listenerMesh;
function init3D(){
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,100);
  camera.position.z=8;
  renderer=new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth,window.innerHeight);
  document.getElementById("threeScene").appendChild(renderer.domElement);

  const light=new THREE.PointLight(0xffffff,1);
  light.position.set(10,10,10);
  scene.add(light);

  const sphere=new THREE.SphereGeometry(0.5,32,32);
  const mat=new THREE.MeshStandardMaterial({color:0x00ff00});
  listenerMesh=new THREE.Mesh(sphere,mat);
  scene.add(listenerMesh);

  const cube=new THREE.BoxGeometry(0.3,0.3,0.3);
  const mat2=new THREE.MeshStandardMaterial({color:0x7c5cff});
  sourceMesh=new THREE.Mesh(cube,mat2);
  scene.add(sourceMesh);

  animate();
}
function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene,camera);
}
function update3D(x,y,z){
  if(sourceMesh){ sourceMesh.position.set(x,y,z); }
}
document.getElementById("open3D").addEventListener("click",()=>{
  document.getElementById("threeContainer").style.display="block";
  if(!scene) init3D();
});
document.getElementById("close3D").addEventListener("click",()=>{
  document.getElementById("threeContainer").style.display="none";
});

// Doble tap en m√≥vil para cerrar
let lastTap=0;
document.getElementById("threeContainer").addEventListener("touchend",()=>{
  const now=Date.now();
  if(now-lastTap<300){ // dos taps en menos de 300ms
    document.getElementById("threeContainer").style.display="none";
  }
  lastTap=now;
});
</script>
</body>
</html>
