<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Audio 8D</title>
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; text-align:center; }
    .dropzone { border:2px dashed #555; padding:20px; margin:20px; }
    .controls { margin:10px; }
    .stage { border:1px solid #555; height:300px; margin:20px; position:relative; }
    .dot { width:14px; height:14px; border-radius:50%; background:#7c5cff;
           position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
    iframe { margin-top:20px; }
  </style>
</head>
<body>
  <h1>Reproductor con efecto 8D</h1>

  <!-- Importar audio -->
  <div class="dropzone" id="dropzone">
    <p>Arrastra un archivo de audio aquí o selecciónalo:</p>
    <input type="file" id="fileInput" accept="audio/*">
    <div class="controls">
      <button id="playBtn" disabled>▶️ Play</button>
      <button id="pauseBtn" disabled>⏸️ Pause</button>
      <label><input type="checkbox" id="reverbToggle"> Reverb</label>
    </div>
    <p id="fileName">Ningún archivo cargado</p>
  </div>

  <!-- Área para mover el mouse -->
  <div class="stage" id="stage">
    <div class="dot" id="dot"></div>
  </div>

  <!-- Links externos -->
  <h2>Reproducir links externos</h2>
  <input id="urlInput" type="text" placeholder="Pega un link de YouTube/Spotify/SoundCloud" size="50">
  <button onclick="loadLink()">Cargar</button>
  <div id="embed"></div>

<script>
let audioCtx, sourceNode, gainNode, panner, convolver, dryGain, wetGain;
let currentBuffer=null;

function ensureAudioGraph(){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if(!gainNode){ gainNode=audioCtx.createGain(); gainNode.connect(audioCtx.destination); }
  if(!panner){
    panner=audioCtx.createPanner();
    panner.panningModel='HRTF';
    panner.connect(gainNode);
  }
}
async function loadFile(file){
  ensureAudioGraph();
  const buf=await file.arrayBuffer();
  currentBuffer=await audioCtx.decodeAudioData(buf);
  document.getElementById("fileName").textContent=file.name;
  playBtn.disabled=false; pauseBtn.disabled=false;
}
function startPlayback(){
  if(!currentBuffer) return;
  stopPlayback();
  sourceNode=audioCtx.createBufferSource();
  sourceNode.buffer=currentBuffer;
  sourceNode.loop=true;
  if(convolver){
    sourceNode.connect(panner);
  } else {
    sourceNode.connect(panner);
  }
  sourceNode.start(); audioCtx.resume();
}
function stopPlayback(){ if(sourceNode){ sourceNode.stop(); sourceNode.disconnect(); sourceNode=null; } }

function setPanner(nx,ny){
  const cx=(nx-0.5)*2, cy=(ny-0.5)*2;
  const r=3;
  const x=cx*r, z=-cy*r, y=cy*r; // altura también
  const t=audioCtx?.currentTime||0;
  panner.positionX.linearRampToValueAtTime(x,t+0.02);
  panner.positionY.linearRampToValueAtTime(y,t+0.02);
  panner.positionZ.linearRampToValueAtTime(z,t+0.02);
  const rect=stage.getBoundingClientRect();
  dot.style.left=`${nx*rect.width}px`; dot.style.top=`${ny*rect.height}px`;
}

// Reverb
function createImpulse(duration=2,decay=2){
  const rate=audioCtx.sampleRate;
  const len=rate*duration;
  const impulse=audioCtx.createBuffer(2,len,rate);
  for(let ch=0;ch<2;ch++){
    const chan=impulse.getChannelData(ch);
    for(let i=0;i<len;i++){ chan[i]=(Math.random()*2-1)*Math.pow(1-i/len,decay); }
  }
  return impulse;
}
function ensureReverb(){
  if(!convolver){
    convolver=audioCtx.createConvolver();
    convolver.buffer=createImpulse();
    dryGain=audioCtx.createGain(); wetGain=audioCtx.createGain();
    dryGain.gain.value=1; wetGain.gain.value=0;
    panner.connect(dryGain); panner.connect(convolver);
    convolver.connect(wetGain);
    dryGain.connect(gainNode); wetGain.connect(gainNode);
  }
}
document.getElementById("reverbToggle").addEventListener("change",e=>{
  ensureReverb();
  wetGain.gain.value=e.target.checked?0.5:0.0;
});

// Eventos
const dropzone=document.getElementById("dropzone");
dropzone.addEventListener("drop",e=>{e.preventDefault(); loadFile(e.dataTransfer.files[0]);});
dropzone.addEventListener("dragover",e=>e.preventDefault());
fileInput.addEventListener("change",e=>loadFile(e.target.files[0]));
playBtn.addEventListener("click",startPlayback);
pauseBtn.addEventListener("click",stopPlayback);
stage.addEventListener("mousemove",e=>{
  const rect=stage.getBoundingClientRect();
  setPanner((e.clientX-rect.left)/rect.width,(e.clientY-rect.top)/rect.height);
});

// Links externos
function loadLink(){
  const url=document.getElementById("urlInput").value;
  const embed=document.getElementById("embed"); embed.innerHTML="";
  if(url.includes("youtube.com")||url.includes("youtu.be")){
    let id=url.split("v=")[1]||url.split("/").pop();
    embed.innerHTML=`<iframe width="560" height="315" src="https://www.youtube.com/embed/${id}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
  } else if(url.includes("spotify.com")){
    let id=url.split("/track/")[1];
    embed.innerHTML=`<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/${id}" width="560" height="152" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>`;
  } else if(url.includes("soundcloud.com")){
    embed.innerHTML=`<iframe width="560" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%23ff5500"></iframe>`;
  } else {
    embed.innerHTML="<p>Formato de link no soportado.</p>";
  }
}
</script>
</body>
</html>
