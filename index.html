<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Audio 8D + Reverb + Paneo extremo</title>
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; text-align:center; }
    .dropzone { border:2px dashed #555; padding:20px; margin:20px; }
    .controls { margin:10px; }
    .stage { border:1px solid #555; height:300px; margin:20px; position:relative; }
    .dot { width:14px; height:14px; border-radius:50%; background:#7c5cff;
           position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
  </style>
</head>
<body>
  <h1>Reproductor con efecto 8D</h1>

  <!-- Importar audio -->
  <div class="dropzone" id="dropzone">
    <p>Arrastra un archivo de audio aquí o selecciónalo:</p>
    <input type="file" id="fileInput" accept="audio/*">
    <div class="controls">
      <button id="playBtn" disabled>▶️ Play</button>
      <button id="pauseBtn" disabled>⏸️ Pause</button>
      <label><input type="checkbox" id="reverbToggle"> Reverb</label>
    </div>
    <p id="fileName">Ningún archivo cargado</p>
  </div>

  <!-- Área para mover el mouse -->
  <div class="stage" id="stage">
    <div class="dot" id="dot"></div>
  </div>

<script>
let audioCtx, sourceNode, gainNode, panner3D, stereoPanner, convolver, dryGain, wetGain;
let currentBuffer=null;

function ensureAudioGraph(){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if(!gainNode){ gainNode=audioCtx.createGain(); gainNode.connect(audioCtx.destination); }
  if(!panner3D){
    panner3D=audioCtx.createPanner();
    panner3D.panningModel='HRTF';
    panner3D.connect(gainNode);
  }
  if(!stereoPanner){
    stereoPanner=audioCtx.createStereoPanner();
    panner3D.disconnect();
    panner3D.connect(stereoPanner);
    stereoPanner.connect(gainNode);
  }
}

// Reverb
function createImpulse(duration=2,decay=2){
  const rate=audioCtx.sampleRate;
  const len=rate*duration;
  const impulse=audioCtx.createBuffer(2,len,rate);
  for(let ch=0;ch<2;ch++){
    const chan=impulse.getChannelData(ch);
    for(let i=0;i<len;i++){ chan[i]=(Math.random()*2-1)*Math.pow(1-i/len,decay); }
  }
  return impulse;
}
function ensureReverb(){
  if(!convolver){
    convolver=audioCtx.createConvolver();
    convolver.buffer=createImpulse();
    dryGain=audioCtx.createGain(); wetGain=audioCtx.createGain();
    dryGain.gain.value=1; wetGain.gain.value=0;
    panner3D.disconnect();
    panner3D.connect(dryGain); panner3D.connect(convolver);
    convolver.connect(wetGain);
    dryGain.connect(stereoPanner); wetGain.connect(stereoPanner);
  }
}
document.getElementById("reverbToggle").addEventListener("change",e=>{
  ensureAudioGraph(); ensureReverb();
  wetGain.gain.value=e.target.checked?0.5:0.0;
});

// Cargar archivo
async function loadFile(file){
  ensureAudioGraph();
  const buf=await file.arrayBuffer();
  currentBuffer=await audioCtx.decodeAudioData(buf);
  document.getElementById("fileName").textContent=file.name;
  playBtn.disabled=false; pauseBtn.disabled=false;
}
function startPlayback(){
  if(!currentBuffer) return;
  stopPlayback();
  sourceNode=audioCtx.createBufferSource();
  sourceNode.buffer=currentBuffer;
  sourceNode.loop=true;
  sourceNode.connect(panner3D);
  sourceNode.start(); audioCtx.resume();
}
function stopPlayback(){ if(sourceNode){ sourceNode.stop(); sourceNode.disconnect(); sourceNode=null; } }

// Posicionamiento 8D + paneo extremo
function setPanner(nx,ny){
  const cx=(nx-0.5)*2, cy=(ny-0.5)*2;
  const r=3;
  const x=cx*r, z=-cy*r, y=cy*r;
  const t=audioCtx?.currentTime||0;
  panner3D.positionX.linearRampToValueAtTime(x,t+0.02);
  panner3D.positionY.linearRampToValueAtTime(y,t+0.02);
  panner3D.positionZ.linearRampToValueAtTime(z,t+0.02);

  // Paneo duro en extremos
  let pan=cx;
  if(Math.abs(cx)>=0.95){ pan=cx>0?1:-1; }
  stereoPanner.pan.setValueAtTime(pan,t);

  const rect=stage.getBoundingClientRect();
  dot.style.left=`${nx*rect.width}px`; dot.style.top=`${ny*rect.height}px`;
}

// Eventos
dropzone.addEventListener("drop",e=>{e.preventDefault(); loadFile(e.dataTransfer.files[0]);});
dropzone.addEventListener("dragover",e=>e.preventDefault());
fileInput.addEventListener("change",e=>loadFile(e.target.files[0]));
playBtn.addEventListener("click",startPlayback);
pauseBtn.addEventListener("click",stopPlayback);
stage.addEventListener("mousemove",e=>{
  const rect=stage.getBoundingClientRect();
  setPanner((e.clientX-rect.left)/rect.width,(e.clientY-rect.top)/rect.height);
});
stage.addEventListener("touchmove",e=>{
  const t=e.touches[0];
  if(t){ const rect=stage.getBoundingClientRect();
    setPanner((t.clientX-rect.left)/rect.width,(t.clientY-rect.top)/rect.height);
  }
},{passive:true});
</script>
</body>
</html>
